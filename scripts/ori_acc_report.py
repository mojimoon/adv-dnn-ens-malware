import xlsxwriter
import os
import pandas as pd

pwd = os.path.dirname(os.path.abspath(__file__))
root = os.path.dirname(pwd)

src = os.path.join(root, 'results', 'ori_acc.csv')

df = pd.read_csv(src)

df['id_ratio'] = df['id_ratio'].apply(lambda x: round(x, 1))

'''
model,ood,id_ratio,ori_acc
deepdrebin,ad2018,0.0,92.7
'''

oods = ['drebin', 'ad2018', 'ad2019']

ood_dict = {
    'drebin': 'DeepDrebin',
    'ad2018': 'AndroZoo 2018',
    'ad2019': 'AndroZoo 2019',
}

id_ratio = [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]

workbook = xlsxwriter.Workbook('results/aggregated/ori_acc.xlsx')

merged_style = workbook.add_format({
    'align': 'center',
    'valign': 'vcenter',
})

def get_mean(df, filters):
    for k, v in filters.items():
        df = df[df[k] == v]
    if not df.empty:
        return df['ori_acc'].mean()
    else:
        return -1

for model in ['deepdrebin', 'basic_dnn']:
    worksheet = workbook.add_worksheet("original-acc-{}".format(model))

    r = 0

    worksheet.write(r, 0, model)

    r += 1

    worksheet.write(r, 0, 'ID Ratio')
    for i, ood in enumerate(oods):
        worksheet.write(r, i + 1, ood_dict[ood])

    r += 1

    for idr in id_ratio:
        worksheet.write(r, 0, idr)
        for i, ood in enumerate(oods):
            filters = {
                'model': model,
                'ood': ood,
                'id_ratio': idr
            }
            mean = get_mean(df, filters)
            worksheet.write(r, i + 1, mean)

        r += 1
    
workbook.close()