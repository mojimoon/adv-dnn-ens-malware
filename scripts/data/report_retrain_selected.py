
import os
import pandas as pd

pwd = os.path.dirname(os.path.abspath(__file__))
_scripts = os.path.dirname(pwd)
root = os.path.dirname(_scripts)
_results = os.path.join(root, 'results')

srcs = [
    os.path.join(_results, 'retrain_fgsm.csv'),
    os.path.join(_results, 'retrain_gdkde.csv'),
    os.path.join(_results, 'retrain_selected_2.csv'),
]

# read data
dfs = [pd.read_csv(src) for src in srcs]

df = pd.concat(dfs, axis=0, ignore_index=True)

id_ratio = [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]

cols = [
    {'selection_metric': 'deepgini', 'budget': 0.1},
    {'selection_metric': 'deepgini', 'budget': 0.2},
    {'selection_metric': 'deepgini', 'budget': 0.3},
    {'selection_metric': 'entropy', 'budget': 0.1},
    {'selection_metric': 'entropy', 'budget': 0.2},
    {'selection_metric': 'entropy', 'budget': 0.3},
    {'selection_metric': 'dat', 'budget': 0.1},
    {'selection_metric': 'dat', 'budget': 0.2},
    {'selection_metric': 'dat', 'budget': 0.3},
    {'selection_metric': 'none', 'budget': 1.0},
]

filters = {
    'epochs': 30,
}

drop_cols = [
    'original_acc',
    'retrain_acc',
]

y_label = 'acc_improvement'

# filter data
for k, v in filters.items():
    df = df[df[k] == v]

# drop columns
df = df.drop(columns=drop_cols)

res = pd.DataFrame(columns=['selection_metric', 'budget', 'id_ratio', 'acc_improvement'])

for col in cols:
    for idr in id_ratio:
        selection_metric = col['selection_metric']
        if selection_metric == 'dat' and idr == 1.0:
            selection_metric = 'deepgini'
        _df = df[(df['selection_metric'] == selection_metric) & (df['budget'] == col['budget']) & (df['id_ratio'] == idr)]
        res = res.append({'selection_metric': col['selection_metric'], 'budget': col['budget'], 'id_ratio': idr, 'acc_improvement': _df[y_label].mean()}, ignore_index=True)


fmt = '''
\multirow{11}{*}{AndroZoo} &0\%+100\% &&&&&&&&&&\\
\multirow{11}{*}{Deepdrebin} &10\%+90\% &&&&&&&&&&\\
&20\%+80\% &&&&&&&&&&\\
&30\%+70\% &&&&&&&&&&\\
 &40\%+60\%&&&&&&&&&&	\\
 &50\%+50\% &&&&&&&&&&\\
 &60\%+40\%&&&&&&&&&&\\
 &70\%+30\%&&&&&&&&&&\\
 &80\%+20\% &&&&&&&&&&\\
 &90\%+10\%&&&&&&&&&& \\
 &100\%+0\% &&&&&&&&&&\\
&\textbf{Average} &&&&&&&&&& \\
'''

output = ''

for idr in id_ratio:
    tmp = ''
    if idr == 0.0:
        tmp = '\multirow{11}{*}{AndroZoo} '
    if idr == 0.1:
        tmp = '\multirow{11}{*}{Deepdrebin} '
    tmp += '&{:.0f}\%+{:.0f}\%'.format(idr * 100, (1 - idr) * 100)

    for col in cols:
        _df = res[(res['selection_metric'] == col['selection_metric']) & (res['budget'] == col['budget']) & (res['id_ratio'] == idr)]
        tmp += ' & {:.2f}'.format(_df['acc_improvement'].values[0])
    
    tmp += '\\\\\n'
    output += tmp

output += '&\\textbf{Average}'
for col in cols:
    _df = res[(res['selection_metric'] == col['selection_metric']) & (res['budget'] == col['budget'])]
    output += ' & {:.2f}'.format(_df['acc_improvement'].mean())
output += '\\\\\n'

print(output)